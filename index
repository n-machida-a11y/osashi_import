<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .container { max-width: 600px; margin-top: 5rem; }
    .card { border: none; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="card-body p-5">
        <h1 class="card-title text-center mb-4">受注データ取込</h1>
        <p class="text-muted small text-center">※複数のTXTファイルを選択できます</p>
        <form id="uploadForm">
          <div class="mb-3">
            <label for="fileInput" class="form-label">テキストファイルを選択</label>
            <!-- multiple 属性を追加 -->
            <input type="file" class="form-control" id="fileInput" accept=".txt,.csv" multiple required>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-lg" id="submitButton">
              <span id="buttonText">アップロードして取込</span>
              <span class="spinner-border spinner-border-sm d-none" id="spinner" role="status" aria-hidden="true"></span>
            </button>
          </div>
        </form>
        <div id="status" class="mt-4"></div>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const files = document.getElementById('fileInput').files;
      if (files.length === 0) return;

      const submitButton = document.getElementById('submitButton');
      const buttonText = document.getElementById('buttonText');
      const spinner = document.getElementById('spinner');
      const statusDiv = document.getElementById('status');

      submitButton.disabled = true;
      buttonText.textContent = '処理中...';
      spinner.classList.remove('d-none');
      statusDiv.innerHTML = '';

      try {
        // 全ファイルを読み込む
        const fileContents = await Promise.all(Array.from(files).map(file => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => resolve(event.target.result);
            reader.onerror = (error) => reject(error);
            reader.readAsText(file, 'Shift_JIS');
          });
        }));

        // サーバーサイドへ送信
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.status === 'success') {
              statusDiv.innerHTML = `
                <div class="alert alert-success" role="alert">
                  <strong>成功:</strong> データの同期が完了しました。<br>
                  受注データ: ${response.ordersAdded}件<br>
                  受注明細: ${response.detailsAdded}件
                </div>`;
            } else {
               showError(response.message);
            }
            resetUi();
          })
          .withFailureHandler(function(error) {
            showError("サーバーエラー: " + error.message);
            resetUi();
          })
          .processCsvData(fileContents); // 配列を送信

      } catch (err) {
        showError("ファイル読み取りエラー: " + err.message);
        resetUi();
      }
    });

    function showError(message) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="alert alert-danger" role="alert"><strong>エラー:</strong> ${message}</div>`;
    }

    function resetUi() {
      const submitButton = document.getElementById('submitButton');
      const buttonText = document.getElementById('buttonText');
      const spinner = document.getElementById('spinner');
      submitButton.disabled = false;
      buttonText.textContent = 'アップロードして取込';
      spinner.classList.add('d-none');
      document.getElementById('fileInput').value = '';
    }
  </script>
</body>
</html>
